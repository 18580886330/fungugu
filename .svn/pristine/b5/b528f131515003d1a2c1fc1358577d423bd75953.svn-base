require(["chatServer/js/chatServer-81890c5ceb.server.js","chatServer/js/ajaxfileupload-909a38fa99.js"],function(e){"use strict";window.yf={setItem:function(e,s){return localStorage.setItem(e,encodeURIComponent("object"==typeof s?JSON.stringify(s):String(s)))},getItem:function(e){return decodeURIComponent(localStorage.getItem(e)).match(/\{/),JSON.parse(decodeURIComponent(localStorage.getItem(e)))},removeItem:function(e){return!!localStorage.getItem(e)&&!localStorage.removeItem(e)},param:function(e){var s=RegExp("[?&]"+e+"=([^&]*)").exec(window.location.href);return s&&decodeURIComponent(s[1].replace(/\+/g," "))},getTime:function(){var e=new Date;return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()+" "+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()}};var s="e9d00a27506c45449c83bcff8f8cb873",t=yf.getItem("userInfo").userName,i=new WebSocket("ws://123.56.239.169:9090/ws?appKey="+s+"&user="+t);({init:function(){this.appKey=s,this.appUser=t,this.bussinessId=yf.param("bussinessID"),this.oMsgResponse=$("#msgResponse"),this.aResponseTtems=this.oMsgResponse.find(".response-item"),this.oMsgTextArea=$("#msgTextArea"),this.oEnquiry=$("#enquiryList"),this.oEnquiryList=$("#enquiryList").find(".list").eq(0),this.oRequestBtns=$("#requestBtns"),this.oTextNull=this.oRequestBtns.find(".text-null").eq(0),this.oSendBtn=this.oRequestBtns.find(".send").eq(0),this.oChangeSendBtn=this.oRequestBtns.find(".send-btn").eq(0),this.oSendType=this.oRequestBtns.find(".send-type").eq(0),this.showResponseObj=this.oMsgResponse.children(".response-item").not(":hidden"),this.getDataList(),this.getSetSendMethod(),this.editMsg(),this.bindEvents(),this.scrollBar(),this.uploadInit(),this.responseMsg()},getDataList:function(){var s=this,t="",i="";e.getOjbectList().success(function(e){console.log(e);for(var e=e.data,n=0;n<e.length;n++){var a=e[n],o=JSON.stringify(a);console.log(o),t+="<li data-id=fgg"+a.bussinessID+' data-info="'+JSON.stringify(a).replace(/\"/g,"'")+'" class="item">                        <div class="item-head"><b class="icon"></b></div>                        <div class="item-info">                            <p class="address">'+a.guJiaDuiXiang+'</p>                            <p class="other">                            <span class="j-area">'+a.jianZhuMianJi+"㎡</span>                            <span>"+(a.suoZaiLouCeng?a.suoZaiLouCeng:"--")+"/"+(a.zongLouCeng?a.zongLouCeng:"--")+"层</span>                            <span>"+(a.fangWuChaoXiang?a.fangWuChaoXiang:"--")+"</span>                            <span>"+(a.wuYeLeiXing?a.wuYeLeiXing:"--")+"</span>                            </p>                        </div>                    </li>"}i=s.oEnquiryList.append(t).find(".item"),s.aResponseTtems.eq(0).attr("data-id",i.eq(0).attr("data-id")),s.objectDetails(i.eq(0).attr("data-info")),i.eq(0).addClass("active"),s.eachEnquiryList(i)}).error(function(e){})},eachEnquiryList:function(e){var s=this;e.each(function(e,t){$(t).unbind("click").bind("click",function(){if(!$(this).hasClass("active")){$(this).find(".tag.new").length&&$(this).find(".tag.new").remove();var e=$(this).attr("data-id"),t=s.oMsgResponse.find('.response-item[data-id="'+e+'"]');if(t.length)t.removeClass("hide").siblings().addClass("hide");else{var i='<div class="response-item" data-id="'+e+'"></div>';s.oMsgResponse.append(i).find('.response-item[data-id="'+e+'"]').removeClass("hide").siblings().addClass("hide")}$(this).addClass("active").siblings().removeClass("active"),s.queryMsgLog(),s.objectDetails($(this).attr("data-info"))}})})},objectDetails:function(e){var e=JSON.parse(e.replace(/\'/g,'"'));console.log(e);var s=$("#objectDetails"),t='<thead>                <tr><th colspan="2" class="name"><h1>三家店中街小区</h1></th></tr>            </thead>            <tbody>                <tr><td class="hd">建筑面积</td><td>'+(e.jianZhuMianJi?e.jianZhuMianJi:"--")+'㎡</td></tr>                <tr><td class="hd">物业类型</td><td>'+(e.wuYeLeiXing?e.wuYeLeiXing:"--")+'</td></tr>                <tr><td class="hd">房屋朝向</td><td>'+(e.fangWuChaoXiang?e.fangWuChaoXiang:"--")+'</td></tr>                <tr><td class="hd">建成年代</td><td>'+(e.jianChengNianDai?e.jianChengNianDai:"--")+'年</td></tr>                <tr><td class="hd">所在楼层</td><td>'+(e.suoZaiLouCeng?e.suoZaiLouCeng:"--")+'层</td></tr>                <tr><td class="hd">总楼层</td><td>'+(e.zongLouCeng?e.zongLouCeng:"--")+'层</td></tr>                <tr><td class="hd">特殊因素</td><td>'+(e.teShuYinSu?e.teShuYinSu:"--")+'</td></tr>                <tr><td class="hd c-yellow">反馈单价</td><td>'+(e.fanKuiDanJia?e.fanKuiDanJia:"--")+'（元）</td></tr>                <tr><td class="hd c-yellow">反馈总价</td><td>'+(e.fanKuiZongJia?e.fanKuiZongJia:"--")+'（万元）</td></tr>                <tr><td class="hd c-blue">核实单价</td><td>'+(e.shenHeDanJia?e.shenHeDanJia:"--")+'（元）</td></tr>                <tr><td class="hd c-blue">核实总价</td><td>'+(e.shenHeZongJia?e.shenHeZongJia:"--")+"（万元）</td></tr>            </tbody>";s.html(t)},queryMsgLog:function(){var e=this;console.log("请求聊天记录开始..."),e.changeScrollOffset()},showMoveMsg:function(){this.msgResponse.find(".move-link").eq(0).unbind("click").bind("click",function(){console.log("查看更多消息")})},sendMsg:function(s,t){var n=this,a="",o=null;console.log(t);var d={bussinessId:n.bussinessId,msgType:t,sendTime:yf.getTime(),msgContent:s};if(e.sendMsg(d).success(function(e){console.log(e)}).error(function(e){}),this.showResponseObj=this.oMsgResponse.children(".response-item").not(":hidden"),""==s)return this.oTextNull.show(),void(o=setTimeout(function(){n.oTextNull.is(":visible")&&n.oTextNull.hide(),clearTimeout(o)},3e3));var r={message:{content:s,type:t},sessionId:n.bussinessId};i.onclose=function(){console.log("连接已段开！")},i.send(JSON.stringify(r)),a='<div class="msg-guest">                    <div class="msg-server-info">                        <b class="icon i"></b>',a+="pic"==t?"<p><img src="+s+" /></p>":"<p>"+s+"</p>",a+='</div>                    <div class="msg-server-hd"></div>                </div>',this.oMsgTextArea.val(""),this.showResponseObj.append(a),this.changeScrollOffset()},responseMsg:function(){var s=this;i.onmessage=function(t){var i=JSON.parse(t.data);console.log(i);var n=JSON.parse(i.message);if(i.sessionId!=s.bussinessId&&i.appKey!=s.appKey&&i.user!=s.appUser){var a=s.oEnquiryList.find('.item[data-id="fgg'+i.sessionId+'"]');if(console.log(a.length),a.length)if(a.hasClass("active")){var o=(l=s.oEnquiryList.find('.item[data-id="fgg'+i.sessionId+'"]').append('<b class="tag new">news</b>')).attr("data-id"),d=s.oMsgResponse.find('.response-item[data-id="'+o+'"]');s.addNewsMsg(n,d)}else{o=(l=s.oEnquiryList.find('.item[data-id="fgg'+i.sessionId+'"]').append('<b class="tag new">news</b>')).attr("data-id");if((d=s.oMsgResponse.find('.response-item[data-id="'+o+'"]')).length)s.addNewsMsg(n,d);else{c=s.oMsgResponse.append('<div class="response-item hide" data-id="'+o+'"></div>').find('.response-item[data-id="'+o+'"]');s.addNewsMsg(n,c)}}else{var r={sessionId:i.sessionId};e.isExistLog(r).success(function(e){if(console.log(e),"500"!=e.code){if("200"==e.code){var t=e.data,i="<li data-id=fgg"+t.bussinessID+' data-info="'+JSON.stringify(t).replace(/\"/g,"'")+'" class="item">                                    <div class="item-head"><b class="icon"></b></div>                                    <div class="item-info">                                        <p class="address">'+t.guJiaDuiXiang+'</p>                                        <p class="other">                                        <span class="j-area">'+t.jianZhuMianJi+"㎡</span>                                        <span>"+(t.suoZaiLouCeng?t.suoZaiLouCeng:"--")+"/"+(t.zongLouCeng?t.zongLouCeng:"--")+"层</span>                                        <span>"+(t.fangWuChaoXiang?t.fangWuChaoXiang:"--")+"</span>                                        <span>"+(t.wuYeLeiXing?t.wuYeLeiXing:"--")+'</span>                                        </p>                                    </div>                                    <b class="tag new">news</b>                                </li>',n=s.oEnquiryList.append(i).find(".item");s.eachEnquiryList(n)}}else console.log("登录过期")}).error(function(e){})}}else if(i.sessionId==s.bussinessId&&i.to==s.appUser){var l=s.oEnquiryList.find('.item[data-id="fgg'+i.sessionId+'"]'),o=l.attr("data-id");if(l.hasClass("active")){d=s.oMsgResponse.find('.response-item[data-id="'+o+'"]');s.addNewsMsg(n,d)}else if(l.append('<b class="tag new">news</b>'),(d=s.oMsgResponse.find('.response-item[data-id="'+o+'"]')).length)s.addNewsMsg(n,d);else{var c=s.oMsgResponse.append('<div class="response-item hide" data-id="'+o+'"></div>').find('.response-item[data-id="'+o+'"]');s.addNewsMsg(n,c)}}}},addNewsMsg:function(e,s){var t=this,i=null,n='<div class="msg-server">                <div class="msg-server-hd"></div>                <div class="msg-server-info">                    <b class="icon i"></b>';"pic"==e.type?n+="<p><img src="+e.content+" /></p>":n+="<p>"+e.content+"</p>",n+="</div>                </div>",s?s.append(n):this.showResponseObj.append(n),i=setTimeout(function(){t.changeScrollOffset(),clearTimeout(i)},10)},editMsg:function(){var e=this;this.oMsgTextArea.unbind("keydown").bind("keydown",function(s){var s=s||window.event,t=sessionStorage.getItem("fggChatSendType"),i=e.oMsgTextArea.val();"0"==t?s.ctrlKey&&13==s.which?(console.log("ctrl+enter 换行"),e.oMsgTextArea.val().length>0?e.oMsgTextArea.val(e.oMsgTextArea.val()+" \r"):e.oMsgTextArea.val(" \r")):s.ctrlKey||13!=s.which?e.oTextNull.hide():(s.preventDefault(),console.log("enter 发消息"),e.sendMsg(i,"text")):"1"==t&&(s.ctrlKey||13!=s.which?s.ctrlKey&&13==s.which?(s.preventDefault(),console.log("Ctrl+Enter 发消息"),e.sendMsg(i,"text")):e.oTextNull.hide():(console.log("enter 换行"),e.oTextNull.hide()))})},bindEvents:function(){var e=this;this.oSendBtn.unbind("click").bind("click",function(){e.sendMsg(e.oMsgTextArea.val(),"text")}),this.oChangeSendBtn.unbind("click").bind("click",function(s){s.stopPropagation(),e.oSendType.toggle(),$(document).bind("click",function(){e.oSendType.is(":visible")&&(e.oSendType.hide(),$(document).unbind("click"))})})},getSetSendMethod:function(){var e=this,s=e.oSendType.find(".list").eq(0).find(".item");sessionStorage.getItem("fggChatSendType")?s.eq(sessionStorage.getItem("fggChatSendType")).addClass("active").siblings().removeClass("active"):(sessionStorage.setItem("fggChatSendType",0),s.eq(0).addClass("active")),s.each(function(s,t){$(t).unbind("click").bind("click",function(){sessionStorage.setItem("fggChatSendType",s),$(this).addClass("active").siblings().removeClass("active"),e.oSendType.hide(),e.editMsg(),$(document).unbind("click")})})},scrollBar:function(){this.oEnquiry.mCustomScrollbar({scrollInertia:180,theme:"inset-3",axis:"y"}),$(".msg-response-scroll").mCustomScrollbar({alwaysShowScrollbar:0,scrollInertia:0,theme:"inset-3",axis:"y"})},changeScrollOffset:function(e){$(".msg-response-scroll").mCustomScrollbar("scrollTo",e||"bottom")},uploadInit:function(e){var s=this;return $("#picUpload").on("change",function(){s.startUpload($(this))}),this},startUpload:function(e){var s=this;e.attr("count",(new Date).getTime());var t=e.attr("id"),i=e.val().toLowerCase().lastIndexOf("."),n=e.val().substr(i),a=[".jpg",".png",".jpeg"];if(a.indexOf(n)<0){var o='<input type="file" id='+t+' name="file" style="top: 46.5px; left: 37px; display: none; height: 29px; width: 74px; display: inline-block; opacity: 0; cursor: pointer; flter:Alpha(opacity=0);"/>';return e.before($(o)),e.remove(),void alert("请上传"+a.join(",")+"类型的图片")}if(/msie/i.test(navigator.userAgent)&&!window.opera&&!$("#"+t)[0].files);else if($("#"+t)[0].files[0].size/1024/1024>5)return alert("请上传5M以下的文件");$.ajaxFileUpload({url:"/api/v1/imageUpload",secureuri:!1,fileElementId:t,type:"post",dataType:"json",success:function(e){var e=JSON.parse(e);$("#"+t).val("");var i=e.data;s.sendMsg(i,"pic")},error:function(e,s,t){console.log(e),console.log(s),console.log(t)}})}}).init()});
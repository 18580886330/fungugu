layui.define("layer",function(e){"use strict";var i=layui.$,t=layui.layer,a=layui.hint(),o=layui.device(),n={config:{},set:function(e){return this.config=i.extend({},this.config,e),this},on:function(e,i){return layui.onevent.call(this,l,e,i)}},l="upload",r="layui-upload-iframe",u=function(e){this.config=i.extend({},this.config,n.config,e),this.render()};u.prototype.config={accept:"images",exts:"",auto:!0,bindAction:"",url:"",field:"file",method:"post",data:{},drag:!0,size:0,multiple:!1},u.prototype.render=function(e){(e=this.config).elem=i(e.elem),e.bindAction=i(e.bindAction),this.file(),this.events()},u.prototype.file=function(){var e=this.config,t=this.elemFile=i(['<input class="layui-upload-file" type="file" name="'+e.field+'"',e.multiple?" multiple":"",">"].join("")),a=e.elem.next();(a.hasClass("layui-upload-file")||a.hasClass("layui-upload-form"))&&a.remove(),o.ie&&o.ie<10&&e.elem.wrap('<div class="layui-upload-wrap"></div>'),this.isFile()?(this.elemFile=e.elem,e.field=e.elem[0].name):e.elem.after(t),o.ie&&o.ie<10&&this.initIE()},u.prototype.initIE=function(){var e=this.config,t=i('<iframe id="'+r+'" class="'+r+'" name="'+r+'" frameborder="0"></iframe>'),a=i(['<form target="'+r+'" class="layui-upload-form" method="'+e.method,'" key="set-mine" enctype="multipart/form-data" action="'+e.url+'">',"</form>"].join(""));i("#"+r)[0]||i("body").append(t),e.elem.next().hasClass(r)||(this.elemFile.wrap(a),e.elem.next("."+r).append(function(){var i=[];return layui.each(e.data,function(e,t){i.push('<input type="hidden" name="'+e+'" value="'+t+'">')}),i.join("")}()))},u.prototype.msg=function(e){return t.msg(e,{icon:2,shift:6})},u.prototype.isFile=function(){var e=this.config.elem[0];if(e)return"input"===e.tagName.toLocaleLowerCase()&&"file"===e.type},u.prototype.preview=function(e){window.FileReader&&layui.each(this.chooseFiles,function(i,t){var a=new FileReader;a.readAsDataURL(t),a.onload=function(){e&&e(i,t,this.result)}})},u.prototype.upload=function(e,t){var a,n=this,l=n.config,c=n.elemFile[0],s=function(){layui.each(e||n.files||n.chooseFiles||c.files,function(e,t){var a=new FormData;a.append(l.field,t),layui.each(l.data,function(e,i){a.append(e,i)}),i.ajax({url:l.url,type:l.method,data:a,contentType:!1,processData:!1,dataType:"json",success:function(i){f(e,i)},error:function(){n.msg("请求上传接口出现异常"),p(e)}})})},f=function(e,i){if(n.elemFile.next(".layui-upload-choose").remove(),c.value="","object"!=typeof i)try{i=JSON.parse(i)}catch(e){return i={},n.msg("请对上传接口返回有效JSON")}"function"==typeof l.done&&l.done(i,e||0,function(e){n.upload(e)})},p=function(e){l.auto&&(c.value=""),"function"==typeof l.error&&l.error(e||0,function(e){n.upload(e)})},d=l.exts,h=function(){var i=[];return layui.each(e||n.chooseFiles,function(e,t){i.push(t.name)}),i}(),m={preview:function(e){n.preview(e)},upload:function(e,i){var t={};t[e]=i,n.upload(t)},pushFile:function(){return n.files=n.files||{},layui.each(n.chooseFiles,function(e,i){n.files[e]=i}),n.files}};switch(h=0===h.length?c.value.match(/[^\/\\]+\..+/g)||[]||"":h,l.accept){case"file":if(d&&!RegExp("\\w\\.("+d+")$","i").test(escape(h)))return n.msg("选择的文件中包含不支持的格式"),c.value="";break;case"video":if(!RegExp("\\w\\.("+(d||"avi|mp4|wma|rmvb|rm|flash|3gp|flv")+")$","i").test(escape(h)))return n.msg("选择的视频中包含不支持的格式"),c.value="";break;case"audio":if(!RegExp("\\w\\.("+(d||"mp3|wav|mid")+")$","i").test(escape(h)))return n.msg("选择的音频中包含不支持的格式"),c.value="";break;default:if(layui.each(h,function(e,i){RegExp("\\w\\.("+(d||"jpg|png|gif|bmp|jpeg$")+")","i").test(escape(i))||(a=!0)}),a)return n.msg("选择的图片中包含不支持的格式"),c.value=""}if(l.size>0&&!(o.ie&&o.ie<10)){var v;if(layui.each(n.chooseFiles,function(e,i){if(i.size>1024*l.size){var t=l.size/1024;t=t>=1?Math.floor(t)+(t%1>0?t.toFixed(1):0)+"MB":l.size+"KB",c.value="",v=t}}),v)return n.msg("文件不能超过"+v)}"choose"===t?l.choose&&l.choose(m):(l.before&&l.before(m),o.ie?o.ie>9?s():function(){var e=i("#"+r);n.elemFile.parent().submit(),clearInterval(u.timer),u.timer=setInterval(function(){var i,t=e.contents().find("body");try{i=t.text()}catch(e){n.msg("获取上传后的响应信息出现异常"),clearInterval(u.timer),p()}i&&(clearInterval(u.timer),t.html(""),f(0,i))},30)}():s())},u.prototype.events=function(){var e=this,t=e.config,n=function(i){e.chooseFiles={},layui.each(i,function(i,t){var a=(new Date).getTime();e.chooseFiles[a+"-"+i]=t})},l=function(i,a){var o=e.elemFile,n=i.length>1?i.length+"个文件":(i[0]||{}).name||o[0].value.match(/[^\/\\]+\..+/g)||[]||"";o.next().hasClass("layui-upload-choose")&&o.next().remove(),e.upload(null,"choose"),e.isFile()||t.choose||o.after('<span class="layui-inline layui-upload-choose">'+n+"</span>")};t.elem.off("upload.start").on("upload.start",function(){var o=i(this),n=o.attr("lay-data");if(n)try{n=new Function("return "+n)(),e.config=i.extend({},t,n)}catch(e){a.error("Upload element property lay-data configuration item has a syntax error: "+n)}e.config.item=o,e.elemFile[0].click()}),o.ie&&o.ie<10||t.elem.off("upload.over").on("upload.over",function(){i(this).attr("lay-over","")}).off("upload.leave").on("upload.leave",function(){i(this).removeAttr("lay-over")}).off("upload.drop").on("upload.drop",function(a,o){var r=i(this),u=o.originalEvent.dataTransfer.files||[];r.removeAttr("lay-over"),n(u),t.auto?e.upload(u):l(u)}),e.elemFile.off("upload.change").on("upload.change",function(){var i=this.files||[];n(i),t.auto?e.upload():l(i)}),t.bindAction.off("upload.action").on("upload.action",function(){e.upload()}),t.elem.data("haveEvents")||(e.elemFile.on("change",function(){i(this).trigger("upload.change")}),t.elem.on("click",function(){e.isFile()||i(this).trigger("upload.start")}),t.drag&&t.elem.on("dragover",function(e){e.preventDefault(),i(this).trigger("upload.over")}).on("dragleave",function(e){i(this).trigger("upload.leave")}).on("drop",function(e){e.preventDefault(),i(this).trigger("upload.drop",e)}),t.bindAction.on("click",function(){i(this).trigger("upload.action")}),t.elem.data("haveEvents",!0))},n.render=function(e){var i=new u(e);return function(){var e=this;return{upload:function(i){e.upload.call(e,i)},config:e.config}}.call(i)},e(l,n)});
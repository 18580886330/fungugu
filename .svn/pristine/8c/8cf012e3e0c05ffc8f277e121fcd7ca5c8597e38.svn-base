require(["chatServer/js/chatServer-6e7ca550bc.server.js","chatServer/js/ajaxfileupload-909a38fa99.js"],function(e){"use strict";window.yf={setItem:function(e,s){return localStorage.setItem(e,encodeURIComponent("object"==typeof s?JSON.stringify(s):String(s)))},getItem:function(e){return decodeURIComponent(localStorage.getItem(e)).match(/\{/),JSON.parse(decodeURIComponent(localStorage.getItem(e)))},removeItem:function(e){return!!localStorage.getItem(e)&&!localStorage.removeItem(e)},param:function(e,s){var i=RegExp("[?&]"+e+"=([^&]*)").exec(s||window.location.href);return i&&decodeURIComponent(i[1].replace(/\+/g," "))},getTime:function(){var e=new Date;return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()+" "+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()},subStr:function(e,s){return null!=e?e.length<=s?e:e.substring(0,s)+"...":""}};({init:function(){this.bussinessId=yf.param("bussinessID"),this.entryCount=!0,this.oMsgResponse=$("#msgResponse"),this.aResponseTtems=this.oMsgResponse.find(".response-item"),this.oMsgTextArea=$("#msgTextArea"),this.oEnquiry=$("#enquiryList"),this.oEnquiryList=$("#enquiryList").find(".list").eq(0),this.oRequestBtns=$("#requestBtns"),this.oTextNull=this.oRequestBtns.find(".text-null").eq(0),this.oSendBtn=this.oRequestBtns.find(".send").eq(0),this.oChangeSendBtn=this.oRequestBtns.find(".send-btn").eq(0),this.oSendType=this.oRequestBtns.find(".send-type").eq(0),this.showResponseObj=this.oMsgResponse.children(".response-item").not(":hidden"),this.positionSize=1,this.wsAppKeyGet(),this.getDataList(),this.getSetSendMethod(),this.editMsg(),this.bindEvents(),this.scrollBar(),this.uploadInit(),this.responseMsg()},wsAppKeyGet:function(){var s=this;e.wsAppKeyGet().success(function(e){var e=e.data;s.appKey=yf.param("appKey",e),s.appUser=yf.param("user",e),s.ws=new WebSocket(e),s.ws.onclose=function(){console.log("连接已段开！");var e=$("#offLine").removeClass("hide");e.find(".move-link").unbind().bind("click",function(){s.wsAppKeyGet(),e.addClass("hide")})}}).error(function(e){})},getDataList:function(){var s=this,i="",t="";e.getOjbectList().success(function(e){if("200"==e.code){for(var e=e.data,n=0;n<e.length;n++){var a=e[n];JSON.stringify(a);i+="<li data-id=fgg"+a.bussinessID+' data-info="'+JSON.stringify(a).replace(/\"/g,"'")+'" class="item">                        <div class="item-head"><b class="icon"></b></div>                        <div class="item-info">                            <p class="address">'+a.guJiaDuiXiang+'</p>                            <p class="other">                            <span class="j-area">'+a.jianZhuMianJi+"㎡</span>                            <span>"+(a.suoZaiLouCeng?a.suoZaiLouCeng:"--")+"/"+(a.zongLouCeng?a.zongLouCeng:"--")+"层</span>                            <span>"+(a.fangWuChaoXiang?a.fangWuChaoXiang:"--")+"</span>                            <span>"+(a.wuYeLeiXing?a.wuYeLeiXing:"--")+"</span>                            </p>                        </div>                    </li>"}if(t=s.oEnquiryList.append(i).find(".item"),s.aResponseTtems.eq(0).attr("data-id",t.eq(0).attr("data-id")),s.objectDetails(t.eq(0).attr("data-info")),t.eq(0).addClass("active"),s.entryCount){var o=s.oMsgResponse.find('.response-item[data-id="'+t.eq(0).attr("data-id")+'"]');s.queryMsgLog(o,s.bussinessId)}s.eachEnquiryList(t)}}).error(function(e){})},eachEnquiryList:function(e){var s=this;e.each(function(e,i){$(i).unbind("click").bind("click",function(){if(!$(this).hasClass("active")){$(this).find(".tag.new").length&&$(this).find(".tag.new").remove();var e=$(this).attr("data-id");if(s.bussinessId=e.replace("fgg",""),(t=s.oMsgResponse.find('.response-item[data-id="'+e+'"]')).length)t.removeClass("hide").siblings().addClass("hide"),s.changeScrollOffset();else{s.entryCount=!1;var i='<div class="response-item" data-id="'+e+'"></div>';s.oMsgResponse.append(i).find('.response-item[data-id="'+e+'"]').siblings().addClass("hide");var t=s.oMsgResponse.find('.response-item[data-id="'+e+'"]');s.positionSize=1,s.queryMsgLog(t,s.bussinessId)}$(this).addClass("active").siblings().removeClass("active"),s.objectDetails($(this).attr("data-info"))}})})},objectDetails:function(e){var e=JSON.parse(e.replace(/\'/g,'"'));this.oObjectDetails=$("#objectDetails");var s='<thead>                <tr><th colspan="2" class="name"><h1>'+yf.subStr(e.guJiaDuiXiang,25)+'</h1></th></tr>            </thead>            <tbody>                <tr><td class="hd">建筑面积</td><td>'+(e.jianZhuMianJi?e.jianZhuMianJi:"--")+'㎡</td></tr>                <tr><td class="hd">物业类型</td><td>'+(e.wuYeLeiXing?e.wuYeLeiXing:"--")+'</td></tr>                <tr><td class="hd">房屋朝向</td><td>'+(e.fangWuChaoXiang?e.fangWuChaoXiang:"--")+'</td></tr>                <tr><td class="hd">建成年代</td><td>'+(e.jianChengNianDai?e.jianChengNianDai:"--")+'年</td></tr>                <tr><td class="hd">所在楼层</td><td>'+(e.suoZaiLouCeng?e.suoZaiLouCeng:"--")+'层</td></tr>                <tr><td class="hd">总楼层</td><td>'+(e.zongLouCeng?e.zongLouCeng:"--")+'层</td></tr>                <tr><td class="hd">特殊因素</td><td>'+(e.teShuYinSu?e.teShuYinSu:"--")+'</td></tr>                <tr><td class="hd c-yellow">反馈单价</td><td>'+(e.fanKuiDanJia?e.fanKuiDanJia:"--")+'（元）</td></tr>                <tr><td class="hd c-yellow">反馈总价</td><td>'+(e.fanKuiZongJia?e.fanKuiZongJia:"--")+'（万元）</td></tr>                <tr><td class="hd c-blue">核实单价</td><td class="unit-price">'+(e.shenHeDanJia?e.shenHeDanJia:"--")+'（元）</td></tr>                <tr><td class="hd c-blue">核实总价</td><td class="total-prece">'+(e.shenHeZongJia?e.shenHeZongJia:"--")+"（万元）</td></tr>            </tbody>";this.oObjectDetails.html(s)},queryMsgLog:function(s,i,t){this.currentElm=s,this.currentSid=i;var n=this,a="",o={sessionId:n.currentSid,positionNo:t||1,rqNums:10};e.queryMsgLogs(o).success(function(e){if("404"!=e.code&&"500"!=e.code){for(var s=e.data.positionSize,e=e.data.list,i=0;i<e.length;i++){var t=e[i];"客服"==t.faSongFang&&(a+='<div class="msg-time"><span>'+t.faSongShiJian+"</span></div>",a+='<div class="msg-server">                            <div class="msg-server-hd"></div>                            <div class="msg-server-info">                                <b class="icon i"></b>',"text"==t.xiaoXiLeiXing?a+="<p>"+t.xiaoXiNeiRong+"</p>":a+='<p><img src="'+t.xiaoXiNeiRong+'"></p>',a+="</div>                        </div>"),"客户"==t.faSongFang&&(a+='<div class="msg-time"><span>'+t.faSongShiJian+"</span></div>",a+='<div class="msg-guest">                            <div class="msg-server-info">                                <b class="icon i"></b>',"text"==t.xiaoXiLeiXing?a+="<p>"+t.xiaoXiNeiRong+"</p>":a+='<p><img src="'+t.xiaoXiNeiRong+'"></p>',a+='</div>                            <div class="msg-server-hd"></div>                        </div>')}if(n.currentElm.prepend(a),n.currentElm.find(".move").remove(),s!=n.positionSize){if(n.currentElm.find(".move").length)return n.currentElm.find(".move").show();n.currentElm.prepend('<div class="move"><b class="icon"></b><a href="javascript:;" class="move-link">查看更多消息</a></div>')}else n.currentElm.prepend('<div class="move"><span class="null-msg">没有更多消息记录了</span></div>');n.showMoveMsg(),n.isMoveClick||n.changeScrollOffset()}}).error(function(e){})},showMoveMsg:function(){var e=this;this.oMsgResponse.find(".move-link").eq(0).unbind("click").bind("click",function(){e.positionSize+=1,e.isMoveClick=!0,e.queryMsgLog(e.currentElm,e.currentSid,e.positionSize)})},sendMsg:function(s,i){var t=this,n="",a=null;if(!$("#offLine").is(":visible")){if(this.showResponseObj=this.oMsgResponse.children(".response-item").not(":hidden"),""==s)return this.oTextNull.show(),void(a=setTimeout(function(){t.oTextNull.is(":visible")&&t.oTextNull.hide(),clearTimeout(a)},3e3));var o={bussinessId:t.bussinessId,msgType:i,sendTime:yf.getTime(),msgContent:s};e.sendMsg(o).success(function(e){console.log(e)}).error(function(e){});var d={message:{content:s,type:i},sessionId:t.bussinessId};this.ws.send(JSON.stringify(d)),n='<div class="msg-time"><span>'+yf.getTime()+'</span></div>\t               \t\t<div class="msg-guest">\t                    <div class="msg-server-info">\t                        <b class="icon i"></b>',n+="pic"==i?"<p><img src="+s+" /></p>":"<p>"+s+"</p>",n+='</div>\t                    <div class="msg-server-hd"></div>\t                </div>',this.oMsgTextArea.val(""),this.showResponseObj.append(n),t.changeScrollOffset()}},responseMsg:function(){var s=this;this.ws.onmessage=function(i){var t=JSON.parse(i.data),n=JSON.parse(t.message);if(t.sessionId!=s.bussinessId&&t.appKey!=s.appKey&&t.user!=s.appUser){var a=s.oEnquiryList.find('.item[data-id="fgg'+t.sessionId+'"]');if(a.length)if(a.hasClass("active")){var o=(c=s.oEnquiryList.find('.item[data-id="fgg'+t.sessionId+'"]').append('<b class="tag new">news</b>')).attr("data-id"),d=s.oMsgResponse.find('.response-item[data-id="'+o+'"]');s.addNewsMsg(n,d)}else{o=(c=s.oEnquiryList.find('.item[data-id="fgg'+t.sessionId+'"]').append('<b class="tag new">news</b>')).attr("data-id");if((d=s.oMsgResponse.find('.response-item[data-id="'+o+'"]')).length)s.addNewsMsg(n,d);else{l=s.oMsgResponse.append('<div class="response-item hide" data-id="'+o+'"></div>').find('.response-item[data-id="'+o+'"]');s.addNewsMsg(n,l)}}else{var r={sessionId:t.sessionId};e.isExistLog(r).success(function(e){if("500"!=e.code){if("200"==e.code){var i=e.data,t="<li data-id=fgg"+i.bussinessID+' data-info="'+JSON.stringify(i).replace(/\"/g,"'")+'" class="item">                                    <div class="item-head"><b class="icon"></b></div>                                    <div class="item-info">                                        <p class="address">'+i.guJiaDuiXiang+'</p>                                        <p class="other">                                        <span class="j-area">'+i.jianZhuMianJi+"㎡</span>                                        <span>"+(i.suoZaiLouCeng?i.suoZaiLouCeng:"--")+"/"+(i.zongLouCeng?i.zongLouCeng:"--")+"层</span>                                        <span>"+(i.fangWuChaoXiang?i.fangWuChaoXiang:"--")+"</span>                                        <span>"+(i.wuYeLeiXing?i.wuYeLeiXing:"--")+'</span>                                        </p>                                    </div>                                    <b class="tag new">news</b>                                </li>',n=s.oEnquiryList.append(t).find(".item");s.eachEnquiryList(n)}}else console.log("登录过期")}).error(function(e){})}}else if(t.sessionId==s.bussinessId&&t.to==s.appUser){var c=s.oEnquiryList.find('.item[data-id="fgg'+t.sessionId+'"]'),o=c.attr("data-id");if(c.hasClass("active")){d=s.oMsgResponse.find('.response-item[data-id="'+o+'"]');s.addNewsMsg(n,d)}else if(c.append('<b class="tag new">news</b>'),(d=s.oMsgResponse.find('.response-item[data-id="'+o+'"]')).length)s.addNewsMsg(n,d);else{var l=s.oMsgResponse.append('<div class="response-item hide" data-id="'+o+'"></div>').find('.response-item[data-id="'+o+'"]');s.addNewsMsg(n,l)}}}},addNewsMsg:function(e,s){var i=this;"inquiry"==e.type&&(this.oObjectDetails.find(".unit-price").eq(0).html(e.inquiryPrice+"（元）"),this.oObjectDetails.find(".total-price").eq(0).html(e.inquiryResult+"（万元）"));var t='<div class="msg-server">                <div class="msg-server-hd"></div>                <div class="msg-server-info">                    <b class="icon i"></b>';"pic"==e.type?t+="<p><img src="+e.content+" /></p>":t+="<p>"+e.content+"</p>",t+="</div>                </div>",s?s.append(t):this.showResponseObj.append(t),i.changeScrollOffset()},editMsg:function(){var e=this;this.oMsgTextArea.unbind("keydown").bind("keydown",function(s){var s=s||window.event,i=sessionStorage.getItem("fggChatSendType"),t=e.oMsgTextArea.val();"0"==i?s.ctrlKey&&13==s.which?(console.log("ctrl+enter 换行"),e.oMsgTextArea.val().length>0?e.oMsgTextArea.val(e.oMsgTextArea.val()+" \r"):e.oMsgTextArea.val(" \r")):s.ctrlKey||13!=s.which?e.oTextNull.hide():(s.preventDefault(),console.log("enter 发消息"),e.sendMsg(t,"text")):"1"==i&&(s.ctrlKey||13!=s.which?s.ctrlKey&&13==s.which?(s.preventDefault(),console.log("Ctrl+Enter 发消息"),e.sendMsg(t,"text")):e.oTextNull.hide():(console.log("enter 换行"),e.oTextNull.hide()))})},bindEvents:function(){var e=this;this.oSendBtn.unbind("click").bind("click",function(){e.sendMsg(e.oMsgTextArea.val(),"text")}),this.oChangeSendBtn.unbind("click").bind("click",function(s){s.stopPropagation(),e.oSendType.toggle(),$(document).bind("click",function(){e.oSendType.is(":visible")&&(e.oSendType.hide(),$(document).unbind("click"))})})},getSetSendMethod:function(){var e=this,s=e.oSendType.find(".list").eq(0).find(".item");sessionStorage.getItem("fggChatSendType")?s.eq(sessionStorage.getItem("fggChatSendType")).addClass("active").siblings().removeClass("active"):(sessionStorage.setItem("fggChatSendType",0),s.eq(0).addClass("active")),s.each(function(s,i){$(i).unbind("click").bind("click",function(){sessionStorage.setItem("fggChatSendType",s),$(this).addClass("active").siblings().removeClass("active"),e.oSendType.hide(),e.editMsg(),$(document).unbind("click")})})},scrollBar:function(){this.oEnquiry.mCustomScrollbar({scrollInertia:180,theme:"inset-3",axis:"y"}),$(".msg-response-scroll").mCustomScrollbar({alwaysShowScrollbar:0,scrollInertia:100,theme:"inset-3",axis:"y"})},changeScrollOffset:function(e){var s=setTimeout(function(){$(".msg-response-scroll").mCustomScrollbar("scrollTo",e||"bottom"),clearTimeout(s)},100)},uploadInit:function(e){var s=this;return $("#picUpload").on("change",function(){s.startUpload($(this))}),this},startUpload:function(e){var s=this;e.attr("count",(new Date).getTime());var i=e.attr("id"),t=e.val().toLowerCase().lastIndexOf("."),n=e.val().substr(t),a=[".jpg",".png",".jpeg"];if(a.indexOf(n)<0)return $("#"+i).val(""),layer.msg("请上传"+a.join(",")+"类型的图片");if(/msie/i.test(navigator.userAgent)&&!window.opera&&!$("#"+i)[0].files);else if($("#"+i)[0].files[0].size/1024/1024>2)return layer.msg("请上传2M以下的文件");$.ajaxFileUpload({url:"/api/v1/imageUpload",secureuri:!1,fileElementId:i,type:"post",data:{bussinessId:s.bussinessId},dataType:"json",success:function(e){var e=JSON.parse(e);if($("#"+i).val(""),!e.data)return layer.msg("图片发送失败");var t=e.data;s.sendMsg(t,"pic")},error:function(e,s,i){console.log(e),console.log(s),console.log(i)}})}}).init()});